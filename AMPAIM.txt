###########
# AMP AIM #
###########


###
# Q2 running
###

PYTHONPATH=/hpc/packages/minerva-centos7/anaconda3/2020.8/pkgs;
export LC_ALL=en_US.UTF-8;
ml anaconda3;
# source activate qiime2-2020.8.0;
source activate /sc/arion/projects/MMEDS/.modules/qiime2-2023.9;

# MMEDS cologin
/opt/collab/bin/cologin mmedsadmin


###
# Adam MMEDs path
###

# original run
/sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_AMP_AIM_MSQ_138_0

# next run with all samples incl EISER
/sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0

# correct samples of 141 with 2 missing fixed
/sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Full_AMP_AIM_MSQ_141_0/Qiime2_0


###
# File Structure
###

inputs/
	Qiime2_2_KB						# everything, but no control no eiser and no healthy 
	Qiime2_1_KB						# psa of eiser and nyu
	Qiime2_nyu         			    # psa, pso, ra no healthy
	Qiime2_psara 					# psa and ra no healthy	
	Qiime2_2a_KB					# DMM on everything incl healthy but no control no eiser
	Qiime2_2b_KB					# DMM on everything w/o healthy, no control no eiser
	Qiime2_nyu_dmm
	Qiime2_psara_dmm
	Qiime2_0_MSQ141					        # MSQ 141 with all samples (24 not 22)
	Qiime2_0_KB_noctrl_noeiser 		  # MSQ138 everything but blank/glass controls and eiser
	Qiime2_0_KB_noctrl_noeiser_nocd # MSQ138 but blank/glass, eiser, and cd
	Qiime2_0_KB_batch_correct_nocd	# MSQ138 + 141 with batch correction
	Qiime2_0_KB_batch_nocd          # MSQ138 + 141 
	Q2_MSQ138_141_noctrl_noeiser_nocd_correct # GG2
		qiime_mapping_file_noctrl_noeiser_nocd.tsv
		qiime_mapping_file_batch_nocd.tsv # copied this to become the above to perserve final names

outputs/
	jobs00              			# validation of eiser; LEfSe of axial v periperhal at L7
	jobs01							# pan RA PsA phenotype as well as each individually, metadata correlations
	jobs02 							# CUTIE jobs of all subsets at L6 and L7
	jobs03							# DMM
	jobs04							# UpSetR
	jobs05              			# CUTIE jobs with FDR at L6 and L7
	jobs06							# PICRUST2 output 
	jobs07							# CUTIE picrust2 L6 and L7
	jobs08							# pairwise jobs (alpha, beta, LEfSe): starting with NSS SS


	jobs09							# reran with batch correction; lefse for merged batch 138 + 141 RA
	jobs10							# '' for PsO				
	jobs11							# '' for PsA
	jobs12							# '' for SS
	jobs13							# '' for sle
	jobs14							# '' for sicca 
	jobs15							# SS vs SICCA MSQ138 only
	jobs16							# '' AvH

	jobs19-26; same for species
	jobs27							# nicer figures for paper in R
	jobs28							# SparCC
	jobs29-33						# clinical severity analyses
	jobs34							# ''
	jobs35							# antibodies	
	jobs36							# SJC TJC ab with alpha, beta pathways, taxa
	jobs37							# taxa
	jobs38							# pathways
	jobs39                          # TEST SRA download PRJNA317370
	jobs40							# PRJNA634145
	jobs41							# PRJNA626512
	jobs42							# PRJNA791216
	

	CDP_MSQ141_batch_correct_GG1
		jobs09							# reran with batch correction; lefse for merged batch 138 + 141 RA
		jobs10							# '' for PsO				
		jobs11							# '' for PsA
		jobs12							# '' for SS
		jobs13							# '' for sle
		jobs14							# '' for sicca 
		jobs15							# SS vs SICCA MSQ138 only
		jobs16							# '' AvH

	CDP_MSQ141/ 
		jobs00 							# CUTIE			
		jobs01	
		jobs02							# LEfSe for PsAvH
		jobs03							# LEfSe for PsOvH
		jobs04							# LEfSe results for UpSetR
		jobs05							# MSQ141 run
		jobs06							# merge, upsetr examples
		jobs07							# AB MSQ135 - MSQ141 help
		jobs08a							# batch correction
		jobs08							# batch correction no cd
		jobs09							# lefse for merged batch 138 + 141 RA
		jobs10							# '' for PsO				
		jobs11							# '' for PsA
		jobs12							# '' for SS
		jobs13							# '' for sle
		jobs14							# '' for sicca 
		jobs15							# SS vs SICCA MSQ138 only
		jobs16							# '' AvH
		jobs17							# '' L7 AvH pilot only
		jobs18							# '' L7 AvH merge
		jobs19							# DMM




graphs/
# LEfSe_0 is RAvUAH, 1 is AvUAH, 2 is PSvUAH
# LEfSe_3/4/5 is AvH, RAvH, and PSvH
# LEfSe 6/7/8/9/10 for SSvH, SLEvH, CDvH, SSSLEvH, RAPsAvH


###
# inputs
###

# original job file with all samples
jobfile_0.lsf 

# with no control
jobfile_kb0_noctrl.lsf

# jobfile with no eiser samples
jobfile_1.lsf

# jobfile with no healthy, for DMM purposes
jobfile_2.lsf

# jobfile with nyu only, no healthy, no ctrl for DMM 
nyu.lsf

# no control no eiser
jobfile_kb0_noctrl_noeiser.lsf

# jobfile with no eiser, no control, no cd
jobfile_noctrl_noeiser_nocd.lsf

# Everything has contaminants except the two tables that specifically say “contams_removed”, which are an ASV table and a genus level table. There’s also a “taxa_removed” file, which just lists the contams that were filtered out

# new jobfiles
/sc/arion/projects/clemej05a/kevin/ampaim/jobs/jobfile_kb0_fix66.lsf  
/sc/arion/projects/clemej05a/kevin/ampaim/jobs/jobfile_kb0_noctrl.lsf 

# for both fix66 and noctrl (fix66 has controls)
# cp jobfile to jobfile_kb0.lsf
# cp qiime_mapping_file_noctrl.tsv to /sc/arion/projects/clemej05a/kevin/ampaim/inputs/
# the mapping file for fix66 was copied to noctrl to not change the lsf script because of all the declarations of $RUN_Qiime2_KB


# batch corrected jobfile with MSQ138 + 141 but no CD
batch_correct_nocd.lsf

# batch corrected jobfile with MSQ138 + 141 no cd no eiser no ctrl AND with GG2
MSQ138_141_noctrl_noeiser_nocd_correct.lsf 

### 
# Merging the run files
###

# the batch corrected file is -> /inputs/Qiime2_0_KB_batch_correct_nocd/otu_table_del1_batch_correct.qza
# this is the dir we want /inputs/Qiime2_0_KB_batch_correct_nocd

# need to generate taxa collapsed table
RUN_Qiime2_CDP=/sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Qiime2_0;
RUN_Qiime2_MSQ141=/sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Full_AMP_AIM_MSQ_141_0/Qiime2_0;
RUN_Qiime2_KB=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd;
RUN_Qiime2=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd;

# merge taxonomy objects
# https://forum.qiime2.org/t/how-to-merge-results-from-different-analyses/447
qiime feature-table merge-taxa \
    --i-data $RUN_Qiime2_CDP/taxonomy.qza \
    --i-data $RUN_Qiime2_MSQ141/taxonomy.qza \
    --o-merged-data $RUN_Qiime2_KB/taxonomy.qza

# move otu table and mapping file into the new directory
mkdir /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/otu_table_del1_batch_correct.qza /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct/
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/qiime_mapping_file_batch_nocd.tsv /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct/






###
# SparCC 
###


# Navigate to repo location (odd)
cd /sc/arion/projects/clemej05a/kevin/Repositories/SparCC

# create env if not already
# git clone 
# then run sparcc.lsf 
# env is called SparCC-env per environment.yml

# activate env
source activate SparCC-env

# create .yml config
# editing to use two-sided pvals
cp twinsra_test.yml ampaim_test.yml
sed -i 's/twinsra/ampaim/g' ampaim_test.yml

# set up directory
SparCC/
	ampaim_test/ # taxa table here should be in traditional untidy format with 'abs' counts
		taxa_table_L6.tsv

# convert /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/taxa_collapsed_table_L6.qza
# from qza to biom to tsv (unzip then convert)
# activate Q2 env
biom convert -i /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/8486a47b-09e8-4594-8daa-e6b73e1c7a9b/data/feature-table.biom -o /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/8486a47b-09e8-4594-8daa-e6b73e1c7a9b/data/taxa_table_L6.tsv --to-tsv

# cp to ampaim_test
# delete first row
sed -i 1d taxa_table_L6.tsv
# change #OTU ID to SampleID without spaces just in case
# run this after copying twinsra_test.yml to configuration.yml
python General_Execution.py 

# mkdir pvals
# be sure to rename to .txt!!!
# delete first col, no spaces


# export for cytoscape; copy to ampaim dir
# feature table came from here /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/8486a47b-09e8-4594-8daa-e6b73e1c7a9b/data/feature-table.biom


source activate /sc/arion/projects/MMEDS/.modules/qiime2-2023.9;
# SPATH=/sc/arion/projects/clemej05a/kevin/Repositories/SparCC/ampaim
# SPATH=/sc/arion/projects/clemej05a/kevin/Repositories/SparCC/ampaim_healthy
# SPATH=/sc/arion/projects/clemej05a/kevin/Repositories/SparCC/ampaim_disease
# SPATH=/sc/arion/projects/clemej05a/kevin/Repositories/SparCC/ampaim_disease0
# SPATH=/sc/arion/projects/clemej05a/kevin/Repositories/SparCC/ampaim_disease1
SPATH=/sc/arion/projects/clemej05a/kevin/Repositories/SparCC/ampaim_disease2


sed 's/,/\t/g' $SPATH/cor_sparcc.csv > $SPATH/cor_sparcc.tsv
sed 's/,/\t/g' $SPATH/pvals/pvals_two_sided.csv > $SPATH/pvals/pvals_two_sided.tsv

python /sc/arion/projects/clemej05a/kevin/scripts/sparcc2network2.0.py -c $SPATH/cor_sparcc.tsv -p $SPATH/pvals/pvals_two_sided.tsv -b $SPATH/taxa_table_L6.txt -o $SPATH/ampaim_cytoscape_5e2.txt -t 0.05

# when importing to cytoscape
# there are node, edge, and network tables (the latter links the former 2)
# make sure the 'key' is selected for the column when importing to node table


# sparcc on separate disease-only and healthy-only networks
# you can only run one at a time...









# stacked taxa barplot
# need a few qza
# asv table
/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct/taxa_collapsed_table_L6.qza

# taxonomy
/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct/taxonomy.qza

# taxa sums by group
# TO BE CREATED

# mapping file
/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct/qiime_mapping_file_batch_nocd.tsv

sp_taxasums = read.csv(file='/Users/KevinBu/Desktop/clemente_lab/Projects/twinsra/inputs/df_q2R.tsv', 
                         sep='\t',
                         row.names='Species')



###
# CUTIE on metadata
###

# jobs we have this lovely file
cutie_L6_psa.ini, cutie_L6_psa.lsf

# we need to replace L6 with L7 and replace psa with pso, RA, psa_RA, pso_RA psa_pso_RA
# also need to replace all instances within the .ini and .lsf files
# '' is extension, for mac os not for unix on hpc

for i in L6 L7;
do 
for j in pso RA psa_pso psa_RA pso_RA psa_pso_RA;
do
cp cutie_${i}_psa.ini cutie_${i}_${j}.ini;
sed -i '' "s/psa/$j/g" cutie_${i}_${j}.ini;
cp cutie_${i}_psa.lsf cutie_${i}_${j}.lsf;
sed -i '' "s/psa/$j/g" cutie_${i}_${j}.lsf;
done;
done;


# now we need fdr
# so we take the L7 files and copy them and also add 10 to the job #

https://askubuntu.com/questions/365877/copy-only-folders-not-files

# creative usage 
find -type d -links 2 -exec mkdir -p "/sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs05/{}" \;

for i in cutie*L7*.lsf;
do 
cp $i FDR_$i;
sed -i 's/cutie_L7/FDR_cutie_L7/g' FDR_$i 
done

for i in cutie*L7*.ini;
do 
cp $i FDR_$i; 
sed -i 's/jobs02/jobs05/g' FDR_$i; 
sed -i 's/nomc/fdr/g' FDR_$i
done



###
# PICRUST2 in jobs06
###

# original script
/sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Puerto_Rico_Nitric_Oxide_Reload_0/PiCRUSt2_1/jobfile_0.lsf

# copied to picrust2.lsf
# requires mmeds cologin
# work on the KOs with JL

python /sc/arion/projects/clemej05a/jakleen/humann/brite/map_ko_kegg_v3.py -i /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/picrust2_out/KO_metagenome_out/pred_metagenome_unstrat.tsv -m /sc/arion/projects/clemej05a/jakleen/humann/brite/ko_map_kegg_20240328.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/picrust2_out/KO_metagenome_out/pred_metagenome_unstrat_kegg.tsv

# picurst2 pcoa

# activate env
source activate /sc/arion/projects/MMEDS/.modules/qiime2-2023.9;

# convert this file into a biom and then into a qza
biom convert --to-hdf5 -i /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/picrust2_out/KO_metagenome_out/pred_metagenome_unstrat_kegg.tsv -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/pred_metagenome_unstrat_kegg.biom

# convert biom to qza
qiime tools import --type 'FeatureTable[Frequency]' --input-path /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/pred_metagenome_unstrat_kegg.biom --output-path /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/pred_metagenome_unstrat_kegg.qza


# diversity analyses in jobs02 
# JL_run_core_metrics.sh, JL_run_core_metrics_alpha_analysis.sh, JL_run_core_metrics_beta_analysis.sh
# renamed to run_core_metrics.sh, etc.
# ensure the following replacements are made 
input_fp=/sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/pred_metagenome_unstrat_kegg.qza
depth=16000000 # min read count sum in file
metadata_fp=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct_old/qiime_mapping_file_batch_nocd.tsv
output_dir=/sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/div/
# manually saved each alpha div tsv metadata as 'metadata_shannon.tsv' etc. from Q2 view

# convert distance matrix to tsv
qiime tools export \
--input-path /sc/arion/projects/clemej05a/kevin/twinsra/outputs/jobs02/Q2_outputs/bray_curtis_distance_matrix.qza \
--output-path /sc/arion/projects/clemej05a/kevin/twinsra/outputs/jobs02/Q2_outputs/

# scp Q2_outputs to local after copying for various plots
cp /sc/arion/projects/clemej05a/kevin/twinsra/outputs/jobs02/Q2_outputs/distance-matrix.tsv /sc/arion/projects/clemej05a/kevin/twinsra/outputs/jobs02/Q2_outputs/bray_curtis_distance_matrix.tsv


# obtain ordination
qiime tools export \
--input-path /sc/arion/projects/clemej05a/kevin/twinsra/outputs/jobs02/Q2_outputs/bray_curtis_pcoa_results.qza \
--output-path /sc/arion/projects/clemej05a/kevin/twinsra/outputs/jobs02/Q2_outputs/




### 
# jobs08; pairwise analyses
###

# make sub directory
mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss

# copy the job file
cp /sc/arion/projects/clemej05a/kevin/ampaim/jobs/MSQ138_141_psa.lsf /sc/arion/projects/clemej05a/kevin/ampaim/jobs/MSQ138_141_nss_ss.lsf

# copy the otu table
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/otu_table_del1_batch_correct.qza /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/

# copy rep seqs
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/rep_seqs_table.qza /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/

# change the following paths
# RUN_Qiime2_KB=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_psa;
# RUN_Qiime2=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_psa;
RUN_Qiime2_KB=/sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss;
RUN_Qiime2=/sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss;

# change the mapping file
# qiime_mapping_file_merge_meds_psaonly.tsv
Q2_map=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_nss_ss.tsv


# create lefse subfolder
mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/lefse

# copy over taxa collapsed table
cp /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/taxa_collapsed_table_L6.qza /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/lefse/

# copy over mapping file
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_nss_ss.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_nss_ss.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/lefse/


# filter table
PYTHONPATH=/hpc/packages/minerva-centos7/anaconda3/2020.8/pkgs;
export LC_ALL=en_US.UTF-8;
ml anaconda3;
# source activate qiime2-2020.8.0;
source activate /sc/arion/projects/MMEDS/.modules/qiime2-2023.9;

# grab L7_AvH from old jobs18
qiime feature-table filter-samples \
--i-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/taxa_collapsed_table_L6.qza   \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/lefse/qiime_mapping_file_merge_nss_ss.tsv \
--p-where '[Diagnosis] IN ("non-sjogrens sicca","ss")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/lefse/L6_nss_ss.qza

# chmod 777 the jobs file and everything in it
chmod 777 /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/lefse/
chmod 777 /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/lefse/*

# change the lefse job file with the correct mapping file
cp /sc/arion/projects/clemej05a/kevin/ampaim/jobs/lefse_psa_AvP_L7_138141.lsf /sc/arion/projects/clemej05a/kevin/ampaim/jobs/lefse_nss_ss_L6_138141.lsf 

sed -i 's/qiime_mapping_file_merge_meds_psaonly/qiime_mapping_file_merge_nss_ss/g' /sc/arion/projects/clemej05a/kevin/ampaim/jobs/lefse_nss_ss_L6_138141.lsf 

# change the RUN_Lefse path
RUN_Lefse=/sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/nss_ss/lefse/

# might have to edit inside the lefse job file to use the new env that's gg2 compatible?

# in a separate tab
/opt/collab/bin/cologin mmedsadmin
cd /sc/arion/projects/clemej05a/kevin/ampaim/jobs/
bsub < lefse_nss_ss_L6_138141.lsf




###
# Eiser validation 
###

##
# jobs00
# take the complete table from input
# subset on ONLY the psa samples
# 

# copy over taxa collapsed table
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct/taxa_collapsed_table_L7.qza /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/

# copy over mapping file
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_meds_psaonly.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/


# filter table
PYTHONPATH=/hpc/packages/minerva-centos7/anaconda3/2020.8/pkgs;
export LC_ALL=en_US.UTF-8;
ml anaconda3;
# source activate qiime2-2020.8.0;
source activate /sc/arion/projects/MMEDS/.modules/qiime2-2023.9;


# grab L7_AvH from old jobs18
qiime feature-table filter-samples \
--i-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/qiime_mapping_file_merge_meds_psaonly.tsv \
--p-where '[Involvement] IN ("axial","peripheral")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/L7_PsA_AvP.qza

# chmod 777 the jobs file and everything in it
chmod 777 /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/
chmod 777 /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/*

# in a separate tab
/opt/collab/bin/cologin mmedsadmin
cd /sc/arion/projects/clemej05a/kevin/ampaim/jobs/
bsub < lefse_psa_AvP_L7_138141.lsf


# using Rscript; code/LEfSe_AvP.R


###
# LEfSe for each disease individually
###

# Define your lists
list1=(RA PsA PsO SS SLE SICCA A)
list2=(jobs09 jobs10 jobs11 jobs12 jobs13 jobs14 jobs16)
list3=(RA psa pso ss sle non-sjogrens sicca 

# this is not quite done yet 
# Use paste to merge the lists together
paste <(printf "%s\n" "${list1[@]}") <(printf "%s\n" "${list2[@]}") <(printf "%s\n" "${list3[@]}") |
# Loop over the merged lists
while IFS=$'\t' read -r item1 item2 item3; do
    echo "List 1: $item1, List 2: $item2, List 3: $item3"
    # You can perform any operation you want with the items here
done




###
# RA jobs09
# PsO jobs10
# PsA jobs11
# ss 12
# sle 13
# sicca 14
# AvH 16,17,18

# must submit from mmeds cologin
# chmod 777 the files and the directory of the output/jobs09 folder
# copy the mapping files into the folder

Q2KB=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L6.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("RA", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs09/L6_RAvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_RAvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs09/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L6.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("pso", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs10/L6_PsOvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_PsOvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs10/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L6.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("psa", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs11/L6_PsAvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_PsAvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs11/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L6.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("ss", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs12/L6_SSvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_SSvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs12/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L6.qza   \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("sle", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs13/L6_SLEvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_SLEvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs13/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L6.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("non-sjogrens sicca", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs14/L6_SICCAvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_SICCAvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs14/
sed -i -e 's/non-sjogrens sicca/nss/g' /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs14/qiime_mapping_file_merge_SICCAvH.tsv

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L6.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("non-sjogrens sicca", "healthy", "ss", "sle", "RA", "psa", "pso")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs16/L6_AvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_AvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs16/

###
# SS vs SICCA jobs15, copied from previous
###

qiime feature-table filter-samples \
--i-table /sc/arion/projects/clemej05a/kevin/ampaim/inputs/MSQ141_ssnss/taxa_collapsed_table_L6.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_MSQ141_meds_ss.tsv \
--p-where '[Diagnosis] IN ("ss", "non-sjogrens sicca")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs15/L6_SSvNSS.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_MSQ141_meds_ss.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs15/
sed -i -e 's/non-sjogrens sicca/nss/g' /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs15/qiime_mapping_file_MSQ141_meds_ss.tsv

# give permissions
chmod 777 /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs*
chmod 777 /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs*/*

# in mmedscologon, can submit all jobs with lefse, not starting with llefse 
for i in lefse*.lsf; do bsub < $i; done

### 
# DMM
###

# make a taxa barplot
qiime taxa barplot --i-table $RUN_Qiime2_KB/filtered_table.qza --i-taxonomy $RUN_Qiime2_KB/taxonomy.qza --m-metadata-file $RUN_Qiime2_KB/qiime_mapping_file_batch_nocd.tsv --o-visualization $RUN_Qiime2_KB/taxa_bar_plot.qzv

# convert taxa barplot qzv into L6 object
# open R script

### 
# L7 lefse
###

Q2KB=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("RA", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs19/L7_RAvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_RAvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs19/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("pso", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs20/L7_PsOvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_PsOvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs20/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("psa", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs21/L7_PsAvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_PsAvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs21/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("ss", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs22/L7_SSvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_SSvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs22/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L7.qza   \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("sle", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs23/L7_SLEvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_SLEvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs23/

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("non-sjogrens sicca", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs24/L7_SICCAvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_SICCAvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs24/
sed -i -e 's/non-sjogrens sicca/nss/g' /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs24/qiime_mapping_file_merge_SICCAvH.tsv

qiime feature-table filter-samples \
--i-table $Q2KB/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[Diagnosis] IN ("non-sjogrens sicca", "healthy", "ss", "sle", "RA", "psa", "pso")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs26/L7_AvH.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_merge_AvH.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs26/

###
# SS vs SICCA jobs15, copied from previous
###

qiime feature-table filter-samples \
--i-table /sc/arion/projects/clemej05a/kevin/ampaim/inputs/MSQ141_ssnss/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_MSQ141_meds_ss.tsv \
--p-where '[Diagnosis] IN ("ss", "non-sjogrens sicca")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs25/L7_SSvNSS.qza

cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_MSQ141_meds_ss.tsv /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs25/
sed -i -e 's/non-sjogrens sicca/nss/g' /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs25/qiime_mapping_file_MSQ141_meds_ss.tsv









###
# Pcopri validation of eiser
###

# /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct_pcopri
# MSQ138_141_noctrl_noeiser_nocd_correct_pcopri.lsf

(1) unzip taxonomy qza for mapping of asv to taxonomic id
(2) unzip rep_seqs for mapping of asv to fastq
(3) convert to fasta, use biopython library and blast
(4) DL blast results as XML and use biopython to read to seqs dict

# import a new taxonomy file and use new job file 

ml anaconda3;
# source activate qiime2-2020.8.0;
source activate /sc/arion/projects/MMEDS/.modules/qiime2-2023.9;


qiime tools import \
  --type 'FeatureData[Taxonomy]' \
  --input-path /sc/arion/projects/clemej05a/kevin/ampaim/inputs/gg2_pcopri_blast_taxonomy.tsv \
  --output-path /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Q2_MSQ138_141_noctrl_noeiser_nocd_correct_pcopri/taxonomy.qza \

# beta div

qiime diversity beta-group-significance --i-distance-matrix $RUN_Qiime2_KB/core_metrics_results/unweighted_unifrac_distance_matrix.qza --m-metadata-file $RUN_Qiime2_KB/qiime_mapping_file_merge_meds_psaonly.tsv --m-metadata-column Involvement --o-visualization $RUN_Qiime2_KB/unweighted_Involvement_significance.qzv --p-pairwise


###
# Submit LEfSE

# don't forget to copy the mapping files in from inputs, also chmod and mmeds cologin

for i in lefse_AvH lefse_PsAvH lefse_PsOvH lefse_RAvH lefse_SICCAvH lefse_SLEvH lefse_SSvH;
do bsub < ${i}.lsf; done

sed -i -e 's/non-sjogrens sicca/nss/g' qiime_mapping_file_merge_SICCAvH.tsv
sed -i -e 's/non-sjogrens sicca/nss/g' qiime_mapping_file_MSQ141_meds_ss.tsv

###
# Manual Beta Div significance
###


# L6 clusters for DMM with and without healthy

qiime diversity beta-group-significance --i-distance-matrix /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_2a_KB/core_metrics_results/unweighted_unifrac_distance_matrix.qza --m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_2a_KB/qiime_mapping_file_dmm_L6.tsv --m-metadata-column dmm.grp --o-visualization /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_2a_KB/unweighted_dmm_significance.qzv --p-pairwise


qiime diversity beta-group-significance --i-distance-matrix /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_2b_KB/core_metrics_results/unweighted_unifrac_distance_matrix.qza --m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_2b_KB/qiime_mapping_file_dmm_nohealthy_L6.tsv --m-metadata-column dmm.grp --o-visualization /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_2b_KB/unweighted_dmm_significance.qzv --p-pairwise


qiime diversity beta-group-significance --i-distance-matrix /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_nyu_dmm/core_metrics_results/unweighted_unifrac_distance_matrix.qza --m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_nyu_dmm/qiime_mapping_file_nyu_dmm.tsv --m-metadata-column dmm.grp --o-visualization /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_nyu_dmm/unweighted_dmm_significance.qzv --p-pairwise


# export distance matrix for glass controls

qiime tools export \
--input-path /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_fix66/core_metrics_results/unweighted_unifrac_distance_matrix.qza \
--output-path /sc/arion/projects/clemej05a/kevin/twinsra/inputs/Qiime2_0_KB_fix66/core_metrics_results/unweighted_unifrac_distance_matrix.tsv \
--output-format .tsv

qiime tools export \
--input-path /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_fix66/core_metrics_results/unweighted_unifrac_distance_matrix.qza \
--output-path /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_fix66/core_metrics_results/



# convert PCOA to tsv
qiime tools export \
--input-path /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_psara_dmm/core_metrics_results/weighted_unifrac_pcoa_results.qza \
--output-path /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_psara_dmm/core_metrics_results/


# unweighted
RUN_Qiime2_KB=/sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_nocd_full/
qiime diversity beta-group-significance \
--i-distance-matrix $RUN_Qiime2_KB/core_metrics_results/unweighted_unifrac_distance_matrix.qza \
--m-metadata-file $RUN_Qiime2_KB/qiime_mapping_file_batch_nocd.tsv \
--m-metadata-column Diagnosis \
--o-visualization $RUN_Qiime2_KB/unweighted_Diagnosis_significance.qzv \
--p-pairwise



###
# Merge is in jobfile batch_beta.lsf
###

batch_beta_nocd.lsf


###
# Testing for batch effects jobs08, jobs09 with no cd
###

# try merging $RUN_Qiime2/rep_seqs_table.qz from both runs
# combine otu table qza  
# combine mapping files
# add column for batch 
# create distance matrix
# do beta group sig and emperor viz
# this is all done in jobs07


# filter samples from otu table
qiime feature-table filter-samples \
--i-table  /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_nocd/otu_table.qza \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv \
--p-where '[SpecimenType] IN ("fecal", "Fecal")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table.qza

# convert otu qza feature table to biom
qiime tools export \
  --input-path /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table.qza \
  --output-path /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/ #feature-table.biom

# convert biom to tsv
biom convert -i /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/feature-table.biom -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table.tsv --to-tsv

# manually delete first row
sed '1d' /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table.tsv > /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1.tsv 
 
# remove '#' from out #OTU ID

# apply batch correction with qiime mapping file
# /sc/arion/projects/MMEDS/batch_correction/batch_correction_runner.py
python /sc/arion/projects/MMEDS/batch_correction/batch_correction_runner.py -i /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1.tsv -m /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_batch_nocd.tsv -b RawDataProtocolID -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1_batch_correct.tsv

# try with -g diagnosis
python /sc/arion/projects/MMEDS/batch_correction/batch_correction_runner.py -i /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1.tsv -m /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/qiime_mapping_file_batch_correct.txt -b RawDataProtocolID -g Diagnosis -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1_batch_correct_diagnosis.tsv

# add '#OTU ID' to the first empty entry of the first row

# convert tsv to biom
biom convert --to-hdf5 -i /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1_batch_correct.tsv -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1_batch_correct.biom

# convert biom to qza frequency feature table
qiime tools import --type 'FeatureTable[Frequency]' --input-path /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1_batch_correct.biom --output-path /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1_batch_correct.qza 

# copy corrected qza
cp /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/otu_table_del1_batch_correct.qza /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_correct_nocd/otu_table_del1_batch_correct.qza

# rerun new batch_beta.lsf 

###
# MSQ141
###

# in inputs
mkdir Q2_MSQ141
mkdir Q2_MSQ141_ss

# copy qiime mapping files from ipynb subsetted on relevant samples
cp qiime_mapping_file_MSQ141_meds_ss.tsv Q2_MSQ141_ss
cp qiime_mapping_file_MSQ141_meds.tsv Q2_MSQ141

# cp otu tables (prior to batch correction)
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_nocd/otu_table.qza Q2_MSQ141/
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_nocd/otu_table.qza Q2_MSQ141_ss/
cp /sc/arion/projects/clemej05a/kevin/ampaim/inputs/Qiime2_0_KB_batch_nocd/rep_seqs_table.qza Q2_MSQ141/
cp /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Full_AMP_AIM_MSQ_141_0/Qiime2_0/rep_seqs_table.qza Q2_MSQ141_ss/





###
# LEfSe
###

# Filter tables into subtables for LEfSe pairwise comparisons. All columns would be in the 'Project' column of metadata.

# original metadata file for filtering
/sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_noctrl.tsv

# qza at L6
/sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Qiime2_0/taxa_collapsed_table_L6.qza   

# Per ADAM's runs: 
# LEfSe_0 is RAvUAH, 1 is AvUAH, 2 is PSvUAH
# LEfSe_3/4/5 is AvH, RAvH, and PSvH
# LEfSe 6/7/8/9/10 for SSvH, SLEvH, CDvH, SSSLEvH, RAPsAvH

# DO NOT aggregate healthy vs affected
# mapping file, class is column Diagnosis, no subclass
/sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_noctrl_AvUAH.tsv

# filter into smaller subsets based on comparison of interest
# done at login node bc fast hopefully
qiime feature-table filter-samples \
--i-table /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Qiime2_0/taxa_collapsed_table_L6.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_noctrl_CDvH.tsv \
--p-where '[Diagnosis] IN ("cd", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/inputs/L6_CDvH.qza

# for L7 analysis, looking for P copri
qiime feature-table filter-samples \
--i-table /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Qiime2_0/taxa_collapsed_table_L7.qza    \
--m-metadata-file /sc/arion/projects/clemej05a/kevin/ampaim/inputs/qiime_mapping_file_noctrl_RAvH.tsv \
--p-where '[Diagnosis] IN ("RA", "healthy")' \
--o-filtered-table /sc/arion/projects/clemej05a/kevin/ampaim/inputs/L7_RAvH.qza


###
# LEfSe plot tweaking
###

# Ran by ADAM
/sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Lefse_0

# left-space, right-space, width
# keep subclades and max_feature_len the same per og job file
# same import qiime modules per above except with source activate lefse
# the above are defaults, width 7->15, max_feature_len 60->160, dpi 72->200

PYTHONPATH=/hpc/packages/minerva-centos7/anaconda3/2020.8/pkgs;
export LC_ALL=en_US.UTF-8;
ml anaconda3;
source activate /sc/arion/projects/MMEDS/.modules/lefse

lefse_plot_res.py /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Lefse_6/lefse_results.res /sc/arion/projects/clemej05a/kevin/ampaim/graphs/results_plot_SSvH.png --format png --max_feature_len 160 --subclades -1 --dpi 200 --left_space 0.2 --right_space 0.1 --width 12;

lefse_plot_res.py /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Lefse_7/lefse_results.res /sc/arion/projects/clemej05a/kevin/ampaim/graphs/results_plot_SLEvH.png --format png --max_feature_len 160 --subclades -1 --dpi 200 --left_space 0.2 --right_space 0.1 --width 12;

lefse_plot_res.py /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Lefse_8/lefse_results.res /sc/arion/projects/clemej05a/kevin/ampaim/graphs/results_plot_CDvH.png --format png --max_feature_len 160 --subclades -1 --dpi 200 --left_space 0.2 --right_space 0.1 --width 12;

lefse_plot_res.py /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Lefse_9/lefse_results.res /sc/arion/projects/clemej05a/kevin/ampaim/graphs/results_plot_SSSLEvH.png --format png --max_feature_len 160 --subclades -1 --dpi 200 --left_space 0.2 --right_space 0.1 --width 12;

lefse_plot_res.py /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Lefse_10/lefse_results.res /sc/arion/projects/clemej05a/kevin/ampaim/graphs/results_plot_RAPsAvH.png --format png --max_feature_len 160 --subclades -1 --dpi 200 --left_space 0.2 --right_space 0.1 --width 12;

lefse_plot_res.py /sc/arion/projects/MMEDS/mmeds_server_data/studies/adamcantor22_Cross_Disease_Pilot_0/Lefse_11/lefse_results.res /sc/arion/projects/clemej05a/kevin/ampaim/graphs/results_plot_RAvH_L7.png --format png --max_feature_len 160 --subclades -1 --dpi 200 --left_space 0.2 --right_space 0.1 --width 12;



###
# CUTIE: jobs00-05
###

# 00 for H forward

mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_H_forward.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_H_forward.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_H_forward.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/ -N cutie_H_forward -n 2 -w 4:00 -s True


# 01 for aggregate (disease) forward

mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs01/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_AD_forward.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_AD_forward.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_AD_forward.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/ -N cutie_AD_forward -n 2 -w 4:00 -s True





###
# jobs00
###



mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/ra_forward_config.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/ -N cutie_ra_forward -n 2 -w 2:00 -s True


###
# jobs01
###

PiCRUSt2 from Adam
EC, KO, pathway are 3 different pathway classifications (e.g. Kegg Ortholog), Adam rec'd using the 3rd folder with the unstratified (what does that mean?)

###
# jobs02
###

metadata taxa correlations only in RA ptx
GLMs to come?

mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs02/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_otumeta.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_otumeta.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_otumeta.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs02/ -N cutie_ra_forward_otumeta -n 2 -w 1:00 -s True


###
# jobs03
###

# reverse of RA in job02

mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs03/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_reverse_otumeta.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_reverse_otumeta.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_reverse_otumeta.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs03/ -N cutie_ra_reverse_otumeta -n 2 -w 2:00 -s True



###
# jobs04, 05
###
# healthy forward and reverse

mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs04/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_healthy_forward_otumeta.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_healthy_forward_otumeta.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_healthy_forward_otumeta.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs04/ -N cutie_healthy_forward_otumeta -n 2 -w 2:00 -s True



mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs05/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_healthy_reverse_otumeta.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_healthy_reverse_otumeta.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_healthy_reverse_otumeta.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs05/ -N cutie_healthy_reverse_otumeta -n 2 -w 2:00 -s True


###
# jobs06, 07
###

# for and rev for pso psa



mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ps_forward_otumeta.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ps_forward_otumeta.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ps_forward_otumeta.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs06/ -N cutie_ps_forward_otumeta -n 2 -w 2:00 -s True



mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs07/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ps_reverse_otumeta.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ps_reverse_otumeta.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ps_reverse_otumeta.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs07/ -N cutie_ps_reverse_otumeta -n 2 -w 2:00 -s True




###
# jobs08 test meta ra for weird lack of TN plots
###

mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/test_ra_reverse_otumeta.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/test_ra_reverse_otumeta.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/test_ra_reverse_otumeta.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs08/ -N test_ra_reverse_otumeta -n 1 -w 1:00 -s True






###
# jobs09 RA metadata w/ fxn corr
###

mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs09/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_pathwaymeta.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_pathwaymeta.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_pathwaymeta.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs09/ -N cutie_ra_forward_pathwaymeta -n 2 -w 1:00 -s True



###
# jobs10 RA  OTU w/ fxn corr
###

mkdir /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs10/
echo 'python /hpc/users/buk02/Repositories/CUTIE/scripts/calculate_cutie.py -i /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_pathwayotu.ini' > /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_pathwayotu.txt

python /hpc/users/buk02/Repositories/labtools/scripts/generate_lsf_chimera.py -c /sc/arion/projects/clemej05a/kevin/ampaim/jobs/cutie_ra_forward_pathwayotu.txt -o /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs10/ -N cutie_ra_forward_pathwayotu -n 2 -w 1:00 -s True




### 
# CUTIE config
###


/sc/arion/projects/clemej05a/kevin/ampaim/jobs/ra_forward_config.ini 

[input]
samp_var1_fp: /sc/arion/projects/clemej05a/kevin/ampaim/inputs/df_otu_ra.tsv
delimiter1: \t
samp_var2_fp: /sc/arion/projects/clemej05a/kevin/ampaim/inputs/df_otu_ra.tsv
delimiter2: \t
f1type: tidy
f2type: tidy
skip1: 0
skip2: 0
startcol1: -1
endcol1: -1
startcol2: -1
endcol2: -1
paired: True
overwrite: True

[output]
working_dir: /sc/arion/projects/clemej05a/kevin/ampaim/outputs/jobs00/
overwrite: True

[stats]
param: p
statistic: spearman
resample_k: 1
alpha: 0.05
mc: nomc
fold: False
fold_value: 1
corr_compare: False

[graph]
graph_bound: 100
fix_axis: False


###
# Meta analyses
###

# jobs39 
# issue with lines somewhere




# jobs41 smol issue with lines
# off by 1
SRR11570827


# pipeline
# (1) download into SRA_data using adam's script
# (2) source activate fastq-pair and delete *fastq and *single*
for file in *_1.fastq; 
do   
prefix="${file%%_*}";   
echo "$prefix"; 
fastq_pair ${prefix}_1.fastq ${prefix}_2.fastq;
done

# (3) rename
rename _1.fastq.paired.fq _S1_L001_R1_001.fastq *;
rename _2.fastq.paired.fq _S1_L001_R2_001.fastq *;

# (4) zip them all

# (5) in MMEDS create new folder
/sc/arion/projects/MMEDS/mmeds_server_data/studies/Kbpi314_AMP_AIM_Validation_2_0/
	#subfolders
	Analysis_core_pipeline_taxonomic_0/
	Snakefile # copy as is?
	config_file.yaml # copy as is?
	jobfile_0.lsf # change these paths
		section_AMPAIM_validation2/
			stripped_output/
				SRR11570850_S1_L001_R1_001.fastq.gz 
				...
		tables/
			# symbolic link to classifier with object edited so 'scikit learn package' is consistent LOL greengenes2.2020-10.nb-classifier.old_qiime2.qza 
			 # #SampleID and HostSubjectId (for LEfSe) and any metadat cols to do lefse on are the only required things! make sure #q2:types and categorical are also present
			 qiime_mapping_file.tsv
	Analysis_lefse_0
		tables/
			qiime_mapping_file.tsv  
			Diagnosis/ # also automatic I think
			taxa_table_L7.qza   # produced automatically i think
			taxa_table_L7.tsv   # also automatic
		jobfile_0.lsf
		Snakefile
		config_file.yaml






